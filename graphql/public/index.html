<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sister 7 - GraphQL</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <h1>Sister 7 - GraphQL</h1>
    
    <!-- ANCHOR Create User Form -->
    <div class="container">
        <h2>Create New User</h2>
        <form id="create-form">
            <div class="form-group">
                <label for="name">Name:</label>
                <input type="text" id="name" required>
            </div>
            <div class="form-group">
                <label for="email">Email:</label>
                <input type="email" id="email" required>
            </div>
            <div class="form-group">
                <label for="age">Age:</label>
                <input type="number" id="age" required>
            </div>
            <button type="submit">Create User</button>
        </form>
    </div>
    
    <!-- ANCHOR Users List -->
    <div class="container">
        <h2>Users List</h2>
        <button onclick="loadUsers()">Refresh Users</button>
        <div id="users-list"></div>
    </div>
    
    <!-- ANCHOR Messages -->
    <div id="messages"></div>

    <script>
        const API_URL = '/graphql';

        // ANCHOR GraphQL query helper function
        async function graphqlQuery(query, variables = {}) {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query: query,
                        variables: variables
                    }),
                });

                const result = await response.json();
                
                if (result.errors) {
                    throw new Error(result.errors[0].message);
                }
                
                return result.data;
            } catch (error) {
                console.error('GraphQL Error:', error);
                showMessage(error.message, 'error');
                throw error;
            }
        }

        // ANCHOR Show messages to user
        function showMessage(message, type = 'success') {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = type;
            messageDiv.textContent = message;
            messagesDiv.appendChild(messageDiv);
            
            // Remove message after 3 seconds
            setTimeout(() => {
                messagesDiv.removeChild(messageDiv);
            }, 3000);
        }

        // ANCHOR Create user
        document.getElementById('create-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const name = document.getElementById('name').value;
            const email = document.getElementById('email').value;
            const age = parseInt(document.getElementById('age').value);

            const mutation = `
                mutation CreateUser($input: UserInput!) {
                    createUser(input: $input) {
                        id
                        name
                        email
                        age
                    }
                }
            `;

            try {
                await graphqlQuery(mutation, {
                    input: { name, email, age }
                });
                
                showMessage('User created successfully!');
                document.getElementById('create-form').reset();
                loadUsers();
            } catch (error) {
                // Error already handled in graphqlQuery
            }
        });

        // ANCHOR Load users
        async function loadUsers() {
            const query = `
                query GetUsers {
                    users {
                        id
                        name
                        email
                        age
                    }
                }
            `;

            try {
                const data = await graphqlQuery(query);
                displayUsers(data.users);
            } catch (error) {
                // Error already handled in graphqlQuery
            }
        }

        // ANCHOR Display users
        function displayUsers(users) {
            const usersList = document.getElementById('users-list');
            usersList.innerHTML = '';

            if (users.length === 0) {
                usersList.innerHTML = '<p>No users found.</p>';
                return;
            }

            users.forEach(user => {
                const userDiv = document.createElement('div');
                userDiv.className = 'user-item';
                userDiv.innerHTML = `
                    <strong>ID:</strong> ${user.id} <br>
                    <strong>Name:</strong> ${user.name} <br>
                    <strong>Email:</strong> ${user.email} <br>
                    <strong>Age:</strong> ${user.age} <br>
                    <button class="update-btn" onclick="showUpdateForm(${user.id})">Update</button>
                    <button class="delete-btn" onclick="deleteUser(${user.id})">Delete</button>
                    
                    <div id="update-form-${user.id}" class="update-form">
                        <h4>Update User</h4>
                        <input type="text" id="update-name-${user.id}" placeholder="Name" value="${user.name}">
                        <input type="email" id="update-email-${user.id}" placeholder="Email" value="${user.email}">
                        <input type="number" id="update-age-${user.id}" placeholder="Age" value="${user.age}">
                        <br>
                        <button onclick="updateUser(${user.id})">Save Changes</button>
                        <button onclick="hideUpdateForm(${user.id})">Cancel</button>
                    </div>
                `;
                usersList.appendChild(userDiv);
            });
        }

        // ANCHOR Show update form
        function showUpdateForm(id) {
            document.getElementById(`update-form-${id}`).style.display = 'block';
        }

        // ANCHOR Hide update form
        function hideUpdateForm(id) {
            document.getElementById(`update-form-${id}`).style.display = 'none';
        }

        // ANCHOR Update user
        async function updateUser(id) {
            const name = document.getElementById(`update-name-${id}`).value;
            const email = document.getElementById(`update-email-${id}`).value;
            const age = parseInt(document.getElementById(`update-age-${id}`).value);

            const mutation = `
                mutation UpdateUser($id: ID!, $input: UpdateUserInput!) {
                    updateUser(id: $id, input: $input) {
                        id
                        name
                        email
                        age
                    }
                }
            `;

            try {
                await graphqlQuery(mutation, {
                    id: id.toString(),
                    input: { name, email, age }
                });
                
                showMessage('User updated successfully!');
                hideUpdateForm(id);
                loadUsers();
            } catch (error) {
                // Error already handled in graphqlQuery
            }
        }

        // ANCHOR Delete user
        async function deleteUser(id) {
            if (!confirm('Are you sure you want to delete this user?')) {
                return;
            }

            const mutation = `
                mutation DeleteUser($id: ID!) {
                    deleteUser(id: $id)
                }
            `;

            try {
                const data = await graphqlQuery(mutation, {
                    id: id.toString()
                });
                
                if (data.deleteUser) {
                    showMessage('User deleted successfully!');
                    loadUsers();
                } else {
                    showMessage('User not found!', 'error');
                }
            } catch (error) {
                // Error already handled in graphqlQuery
            }
        }

        // ANCHOR Load users when page loads
        document.addEventListener('DOMContentLoaded', loadUsers);
    </script>
</body>
</html>